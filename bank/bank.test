<?php
/**
 * @file
 * Tests the functionality bank module.
 */
class BankTestCase extends DrupalWebTestCase {
  /**
   * @var user
   * The site administrator.
   */
  protected $globalAdminUser;
  /**
   * @var user
   * The exchange1 creator and administrator.
   */
  protected $exchange1Admin;
  /**
   * @var user
   * exchange1 first user.
   */
  protected $exchange1User1;
  /**
   * @var user
   * exchange1 second user.
   */
  protected $exchange1User2;
  /**
   * @var user
   * The exchange1 creator and administrator.
   */
  protected $exchange2Admin;
  /**
   * @var user
   * exchange2 first user.
   */
  protected $exchange2User1;
  /**
   * @var user
   * exchange2 second user.
   */
  protected $exchange2User2;
  /**
   * @var user
   * exchange1 and exchange 2 user.
   */
  protected $exchangeXUser1;
  /**
   * @var exchange1 record.
   */
  protected $exchange1;
  /**
   * @var exchange2 record.
   */
  protected $exchange2;

  public static function getInfo() {
    return array(
      'name' => 'bank',
      'description' => 'Test bank module features. Create exchange, create accounts, do transactions...',
      'group' => 'CES',
    );
  }

  public function setUp() {
    $bank = new Bank();
    // Enable any modules required for the test. It also enables dependences.
    parent::setUp('bank');
    // Create global administrator.
    $this->globalAdminUser = $this->drupalCreateUser(array('administer blocks', 'access administration pages'));
    $permission = array(
      'permission'=>Permission::PERMISSION_ADMIN,
      'object' => 'global',
      'objectid' => 0,
      'scope' => 'user',
      'scopeid' => $this->globalAdminUser->uid,
    );
    $bank->createPermission($permission);
    
    $this->exchange1Admin = $this->drupalCreateUser(array());
    $this->exchange1User1 = $this->drupalCreateUser(array());
    $this->exchange1User2 = $this->drupalCreateUser(array());
    
    $this->exchange2Admin = $this->drupalCreateUser(array());
    $this->exchange2User1 = $this->drupalCreateUser(array());
    $this->exchange2User2 = $this->drupalCreateUser(array());
    
    $this->exchangeXUser1 = $this->drupalCreateUser(array());
    
    $this->exchange1 = array(
      'code' => 'HORA',
      'shortname' => 'EX Bages',
      'name' => 'A bona hora - Ecoxarxa del Bages',
      'website' => 'http://abonahora.wordpress.com',
      'country' => 'ES',
      'region' => 'Bages',
      'town' => 'Manresa',
      'map' => 'http://maps.google.com/?ll=41.723796,1.832142&spn=0.083663,0.145912&hnear=Manresa,+Province+of+Barcelona,+Catalonia,+Spain&t=m&z',
      'currencysymbol' => 'ℏ',
      'currencyname' => 'hora',
      'currenciesname' => 'hores',
      'currencyvalue' => '1.0',
      'currencyscale' => '2',
    );
    
    $this->exchange2 = array(
      'code' => 'BCNA',
      'shortname' => 'EX Barna',
      'name' => 'Ecoxarxa de Barcelona',
      'website' => 'http://cooperativa.ecoxarxes.cat',
      'country' => 'ES',
      'region' => 'Barcelonès',
      'town' => 'Barcelona',
      'map' => 'http://maps.google.com/barcelona',
      'currencysymbol' => 'ECO',
      'currencyname' => 'eco',
      'currenciesname' => 'ecos',
      'currencyvalue' => '0.1',
      'currencyscale' => '2',
    );
  }

  public function testBank() {
    //setup menu block.
    $this->setupMenuBlock();
    
    $this->exchange1 = $this->createExchange($this->exchange1Admin, $this->exchange1);
    $this->exchange1 = $this->activateExchange($this->globalAdminUser, $this->exchange1);
    
    $account11 = $this->createAccount($this->exchange1User1, $this->exchange1);
    $account12 = $this->createAccount($this->exchange1User2, $this->exchange1);
    $account11 = $this->activateAccount($this->exchange1Admin, $account11);
    $account12 = $this->activateAccount($this->exchange1Admin, $account12);
    
    $this->createTransaction($this->exchange1User1, $account11, $account12, '1.50', 'First transaction');
    $this->createTransaction($this->exchange1User1, $account11, $account12, '2.50', 'Second transaction');
    $this->createTransaction($this->exchange1User2, $account12, $account11, '1.00', 'Third transaction');
    
    $this->assertBalance($this->exchange1User1, $account11, '3.00');
    $this->assertBalance($this->exchange1User2, $account12, '-3.00');
  }
  protected function setupMenuBlock() {
    $this->drupalLogin($this->globalAdminUser);
    $this->drupalPost('admin/structure/block', array('blocks[bank_navigation][region]'=>'sidebar_first'), t('Save blocks'));
    $this->assertFieldByName('blocks[bank_navigation][region]', 'sidebar_first');
    $this->drupalGet('ces/bank/dashboard');
    $this->assertText(t('CES Navigation'));
  }
  protected function assertBalance($user, $account, $amount) {
    //TODO: assuere account is the given. Assert balance also in account statement.
    $this->drupalLogin($user);
    $this->drupalGet('ces/bank/dashboard');
    $this->clickLink(t('Dashboard'));
    $this->assertText($amount);
  }
  protected function activateAccount($admin, $record) {
    $this->drupalLogin($admin);
    $this->drupalGet('ces/bank/dashboard');
    $this->clickLink(t('Administrative interface'));
    $this->clickLink($record['name']);
    $this->drupalPost(NULL, array(), t('Activate account'));
    $this->assertRaw(t('Account sucessfully activated.'));
    return $record;
  }
  protected function createExchange($admin, $record) {
    $this->drupalLogin($admin);
    $this->drupalGet('ces/bank/exchange/new');
    $this->assertText(t('General'));
    $this->assertText(t('Location'));
    $this->assertText(t('Currency'));
    
    $this->drupalPost(NULL, $record, t('Create exchange'));
    $this->assertRaw(t('Exchange %code successfully created.', array('%code' => $this->exchange1['code'])));
    return $record;
  }

  protected function activateExchange($globaladmin, $record) {
    $this->drupalLogin($globaladmin);
    $this->drupalGet('ces/bank/admin');
    $this->clickLink($record['code'] . ' - ' . $record['name']);
    $this->assertFieldByName('code', $this->exchange1['code']);
    $this->assertFieldByName('name', $this->exchange1['name']);
    $this->drupalPost(NULL, array(), t('Activate exchange'));
    $this->assertRaw(t('Exchange %code successfully activated.', array('%code' => $this->exchange1['code'])));
    $this->assertText(t('Limits'));
    return $record;
  }

  protected function createAccount($user, $exchange) {
    static $lastAccountId = 0;
    
    $this->drupalLogin($user);
    $this->drupalGet('ces/bank/exchange');
    //little hack:
    $index = ($exchange['code'] == $this->exchange1['code']) ? 0 : 1;
    $this->clickLink(t('Register'), $index);
    $record = array(
      'kind' => '0',
    );
    $name = $exchange['code'].'000'.($lastAccountId+1);
    
    $this->assertFieldByName('name', $name);
    $this->assertFieldByName('username', $user->name);
    
    $this->drupalPost(NULL, $record, t('Create account'));
    $this->assertText(t('Account successfully created.'));
    $lastAccountId++;
    
    $record['name'] = $name;
    $record['username'] = $user->name;
    
    return $record;
  }

  protected function createTransaction($user, $seller, $buyer, $amount, $concept) {
    $this->drupalLogin($user);
    $this->drupalGet('ces/bank/dashboard');
    $this->clickLink(t('Charge a sale'));
    $edit = array(
        'fromaccountname' => $buyer['name'],
        'concept' => $concept,
        'amount' => $amount,
    );
    $this->drupalPost(NULL, $edit, t('Create transaction'));
    $this->assertText($seller['name']);
    $this->assertText($buyer['name']);
    $this->assertText($amount);
    $this->assertText($concept);
    $this->drupalPost(NULL, array(), t('Confirm transaction'));
    $this->assertText(t('Transaction successfully applied.'));
  }
}